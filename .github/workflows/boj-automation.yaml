# GitHub Actions ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: BOJ Study Automation (Gemini API)

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´
on:
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 0 * * *" # ë§¤ì¼ ìì •(UTC)ì— ì‹¤í–‰

# ì‹¤í–‰ë  ì‘ì—…(Job) ëª©ë¡
jobs:
  # PR ê²€ì¦ ë° ìë™ ë³‘í•© ì‘ì—…
  test-and-merge:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    # ì‘ì—…ì— í•„ìš”í•œ ê¶Œí•œ ì„¤ì •
    permissions:
      contents: write # README.md ì—…ë°ì´íŠ¸ ë° ì»¤ë°‹/í‘¸ì‹œë¥¼ ìœ„í•´ í•„ìš”
      pull-requests: write # PRì— í…ŒìŠ¤íŠ¸ ê²°ê³¼ ëŒ“ê¸€ì„ ì‘ì„±í•˜ê¸° ìœ„í•´ í•„ìš”

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.ref }}

      # 2. Python í™˜ê²½ ì„¤ì •
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # 3. Java í™˜ê²½ ì„¤ì •
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "11"

      # 4. Python ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-genai pytz beautifulsoup4 requests

      # 5. Gemini API í™˜ê²½ í…ŒìŠ¤íŠ¸
      - name: Test Gemini API environment
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸ¤– Gemini API í™˜ê²½ í…ŒìŠ¤íŠ¸..."
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "âŒ GEMINI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          cat > test_gemini_api.py << 'EOF'
          import os
          import sys
          try:
              from google import genai
              from google.genai import types
              print("âœ… google-genai ë¼ì´ë¸ŒëŸ¬ë¦¬ import ì„±ê³µ")
              
              client = genai.Client(api_key=os.environ["GEMINI_API_KEY"])
              print("âœ… Gemini API í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì„±ê³µ")

              response = client.models.generate_content(
                  model="gemini-1.5-flash",
                  contents="Hello, can you respond with just 'API_TEST_SUCCESS'?",
              )
              
              if hasattr(response, "text") and "API_TEST_SUCCESS" in response.text:
                  print("âœ… Gemini API í…ŒìŠ¤íŠ¸ ì™„ë£Œ")
                  sys.exit(0)
              else:
                  text = response.text if hasattr(response, "text") else "No text"
                  print(f"âš ï¸ API ì‘ë‹µ í™•ì¸: {text}")
                  sys.exit(0)
          except Exception as e:
              print(f"âŒ Gemini API ì—°ê²° ì‹¤íŒ¨: {e}")
              sys.exit(1)
          EOF
          python test_gemini_api.py

      # 6. PRì—ì„œ ë³€ê²½ëœ íŒŒì¼ë“¤ ë° ë¬¸ì œ ì •ë³´ ì¶”ì¶œ
      - name: Extract changed files and problem info
        id: extract-info
        run: python scripts/extract_pr_info.py
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 7. íŒŒì¼ êµ¬ì¡° ë° ìœ íš¨ì„± í™•ì¸
      - name: Check valid problems
        id: check-validity
        run: |
          if [ "${{ steps.extract-info.outputs.has_valid_problems }}" = "false" ] || [ "${{ steps.extract-info.outputs.total_problems_count }}" = "0" ]; then
            echo "skip_tests=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ ë¶„ì„í•  ìˆ˜ ìˆëŠ” ìœ íš¨í•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤."
          else
            echo "skip_tests=false" >> $GITHUB_OUTPUT
            echo "âœ… ${{ steps.extract-info.outputs.total_problems_count }}ê°œì˜ ìœ íš¨í•œ ë¬¸ì œë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤."
          fi

      # 8. ë‹¤ì¤‘ ë¬¸ì œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Run multi-problem tests
        if: steps.check-validity.outputs.skip_tests == 'false'
        id: run-tests
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python scripts/multi_test_runner.py
        continue-on-error: true

      # 9. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„
      - name: Analyze test results
        if: steps.check-validity.outputs.skip_tests == 'false'
        id: analyze-results
        run: |
          if [ -f "test_results_summary.json" ]; then
            echo "ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„ ì¤‘..."
            python -c "
import json
import os
with open('test_results_summary.json', 'r', encoding='utf-8') as f:
    results = json.load(f)
overall_success = results.get('overall_success', False)
total_problems = results.get('total_problems', 0)
passed_problems = results.get('passed_problems', 0)
partial_passed = results.get('partial_passed_problems', 0)
failed_problems = results.get('failed_problems', 0)
with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as f:
    f.write(f'overall_result={'PASS' if overall_success else 'FAIL'}\n')
    f.write(f'total_problems={total_problems}\n')
    f.write(f'passed_problems={passed_problems}\n')
    f.write(f'partial_passed_problems={partial_passed}\n')
    f.write(f'failed_problems={failed_problems}\n')
    f.write(f'success_rate={round((passed_problems + partial_passed) / max(total_problems, 1) * 100, 1)}\n')
print(f'ì „ì²´ ê²°ê³¼: {'ì„±ê³µ' if overall_success else 'ì‹¤íŒ¨'}')
"
          else
            echo "âŒ í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "overall_result=FAIL" >> $GITHUB_OUTPUT
          fi

      # 10. README.md ì—…ë°ì´íŠ¸ (ì„±ê³µí•œ ë¬¸ì œë“¤ë§Œ)
      - name: Update README for successful problems
        if: steps.analyze-results.outputs.overall_result == 'PASS'
        run: |
          if [ -f "test_results_summary.json" ]; then
            echo "ğŸ“Š README ì—…ë°ì´íŠ¸ ì¤‘..."
            python -c "
import json
import subprocess
import sys
from datetime import datetime
try:
    with open('test_results_summary.json', 'r', encoding='utf-8') as f:
        results = json.load(f)
    successful_problems = [d for d in results.get('details', []) if d['result'] in ['PASS', 'PARTIAL_PASS']]
    if not successful_problems:
        print('âœ… ì—…ë°ì´íŠ¸í•  ì„±ê³µí•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.')
        sys.exit(0)
    print(f'âœ… README ì—…ë°ì´íŠ¸ ëŒ€ìƒ: {len(successful_problems)}ê°œ ë¬¸ì œ')
    for problem in successful_problems:
        cmd = [
            'python', 'scripts/update_readme.py',
            '--problem-id', str(problem['problem_id']),
            '--author', problem['author'],
            '--submission-date', datetime.now().strftime('%Y-%m-%d'),
            '--language', 'Java'
        ]
        try:
            subprocess.run(cmd, check=True, timeout=30)
            print(f'  - ë¬¸ì œ {problem['problem_id']} README ì—…ë°ì´íŠ¸ ì™„ë£Œ')
        except Exception as e:
            print(f'  - âš ï¸ ë¬¸ì œ {problem['problem_id']} README ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: {e}')
except Exception as e:
    print(f'âŒ README ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜: {e}')
    sys.exit(1)
"
          fi

      # 11. README.md ë³€ê²½ì‚¬í•­ì„ PR ë¸Œëœì¹˜ì— ì»¤ë°‹ ë° í‘¸ì‹œ
      - name: Commit and Push README changes
        if: steps.analyze-results.outputs.overall_result == 'PASS'
        run: |
          git config --local user.email "${{ github.event.pull_request.user.login }}@users.noreply.github.com"
          git config --local user.name "${{ github.event.pull_request.user.login }}"
          git add README.md
          if ! git diff --cached --quiet; then
            SUCCESS_COUNT="${{ steps.analyze-results.outputs.passed_problems }}"
            PARTIAL_COUNT="${{ steps.analyze-results.outputs.partial_passed_problems }}"
            TOTAL_COUNT="${{ steps.analyze-results.outputs.total_problems }}"
            git commit -m "docs(readme): í‘¼ ë¬¸ì œ ì—…ë°ì´íŠ¸ (${SUCCESS_COUNT}+${PARTIAL_COUNT}/${TOTAL_COUNT}) by ${{ steps.extract-info.outputs.author }}"
            git push origin ${{ github.event.pull_request.head.ref }}
          else
            echo "README.mdì— ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ì»¤ë°‹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          fi

      # 12. ìƒì„¸í•œ ì„±ê³µ ì•Œë¦¼ ì „ì†¡
      - name: Send detailed success notification
        if: steps.analyze-results.outputs.overall_result == 'PASS'
        env:
          MATTERMOST_WEBHOOK_URL: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
        run: |
          echo "ğŸ“¢ ì„±ê³µ ì•Œë¦¼ ì „ì†¡ ì¤‘..."
          python -c "
import json, subprocess, os, tempfile
try:
    with open('test_results_summary.json', 'r', encoding='utf-8') as f:
        results = json.load(f)
    
    total, passed, partial, failed = (
        results.get('total_problems', 0), results.get('passed_problems', 0),
        results.get('partial_passed_problems', 0), results.get('failed_problems', 0)
    )
    
    success_list = [f'**{d['problem_id']}** ({d['author']})' for d in results.get('details', []) if d['result'] == 'PASS']
    partial_list = [f'**{d['problem_id']}** ({d['author']})' for d in results.get('details', []) if d['result'] == 'PARTIAL_PASS']
    
    message_parts = [
        'ğŸ‰ **Multiple Problems Test Results**',
        f'**Total**: {total}ê°œ | **Success**: {passed}ê°œ | **Partial**: {partial}ê°œ | **Failed**: {failed}ê°œ',
        f'**Success Rate**: {round((passed + partial) / max(total, 1) * 100, 1)}%',
        f'**PR**: ${{ github.event.pull_request.html_url }}'
    ]
    if success_list: message_parts.append(f'**âœ… ì™„ì „ ì„±ê³µ**: {' | '.join(success_list)}')
    if partial_list: message_parts.append(f'**âš ï¸ ë¶€ë¶„ ì„±ê³µ**: {' | '.join(partial_list)}')
    message_parts.append('ğŸ¯ í•œ ë¬¸ì œ ì´ìƒ ì„±ê³µìœ¼ë¡œ PR ìŠ¹ì¸ë©ë‹ˆë‹¤!')
    
    payload = {'username': 'BOJ-Bot', 'icon_emoji': ':white_check_mark:', 'text': '\n\n'.join(message_parts)}
    
    with tempfile.NamedTemporaryFile(mode='w', suffix='.json', delete=False) as f:
        json.dump(payload, f)
        payload_file = f.name
    
    webhook_url = os.environ.get('MATTERMOST_WEBHOOK_URL')
    if webhook_url:
        subprocess.run(['curl', '-X', 'POST', '-H', 'Content-Type: application/json', '-d', f'@{payload_file}', webhook_url, '--fail', '--silent', '--show-error'], check=True)
        os.unlink(payload_file)
        print('âœ… ì„±ê³µ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ')
    else:
        print('âš ï¸ MATTERMOST_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤.')

except Exception as e:
    print(f'âŒ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: {e}')
"

      # 13. ìƒì„¸í•œ ì‹¤íŒ¨ ì•Œë¦¼ ì „ì†¡
      - name: Send detailed failure notification
        if: failure() && steps.check-validity.outputs.skip_tests == 'false'
        env:
          MATTERMOST_WEBHOOK_URL: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
        run: |
          echo "ğŸ“¢ ì‹¤íŒ¨ ì•Œë¦¼ ì „ì†¡ ì¤‘..."
          python -c "
import json, subprocess, os, tempfile
try:
    with open('test_results_summary.json', 'r', encoding='utf-8') as f:
        results = json.load(f)
    
    total, passed, partial, failed, error = (
        results.get('total_problems', 0), results.get('passed_problems', 0),
        results.get('partial_passed_problems', 0), results.get('failed_problems', 0),
        results.get('error_problems', 0)
    )
    
    failure_details = []
    for detail in results.get('details', []):
        if detail['result'] in ['FAIL', 'ERROR']:
            error_summary = (detail.get('errors', ['ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'])[0] or 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜')[:100]
            failure_details.append(f'**{detail['problem_id']}** ({detail['author']}): {error_summary}...')

    message_parts = [
        'âŒ **Multiple Problems Test Failed**',
        f'**Total**: {total}ê°œ | **Success**: {passed}ê°œ | **Partial**: {partial}ê°œ | **Failed**: {failed}ê°œ | **Error**: {error}ê°œ',
        f'**PR**: ${{ github.event.pull_request.html_url }}'
    ]
    if failure_details:
        message_parts.append('**ì‹¤íŒ¨ ìƒì„¸:**')
        message_parts.extend(failure_details[:5])
        if len(failure_details) > 5: message_parts.append(f'... ì™¸ {len(failure_details) - 5}ê°œ ë”')
    message_parts.append('ğŸ’ª ì½”ë“œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”!')
    
    payload = {'username': 'BOJ-Bot', 'icon_emoji': ':x:', 'text': '\n\n'.join(message_parts)}
    
    with tempfile.NamedTemporaryFile(mode='w', suffix='.json', delete=False) as f:
        json.dump(payload, f)
        payload_file = f.name
    
    webhook_url = os.environ.get('MATTERMOST_WEBHOOK_URL')
    if webhook_url:
        subprocess.run(['curl', '-X', 'POST', '-H', 'Content-Type: application/json', '-d', f'@{payload_file}', webhook_url, '--fail', '--silent', '--show-error'], check=True)
        os.unlink(payload_file)
        print('âœ… ì‹¤íŒ¨ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ')
    else:
        print('âš ï¸ MATTERMOST_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤.')

except Exception as e:
    print(f'âŒ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: {e}')
"

      # 14. PRì— ìƒì„¸í•œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ëŒ“ê¸€ ì‘ì„±
      - name: Comment detailed test results
        if: always() && steps.check-validity.outputs.skip_tests == 'false'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let results;
            try {
              if (fs.existsSync('test_results_summary.json')) {
                results = JSON.parse(fs.readFileSync('test_results_summary.json', 'utf8'));
              }
            } catch (error) {
              console.log('ê²°ê³¼ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
            
            const overall_result = "${{ steps.analyze-results.outputs.overall_result }}";
            if (!results) {
              return github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## âŒ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨\n\ní…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì¼ì„ ì°¾ê±°ë‚˜ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì›Œí¬í”Œë¡œìš° ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`
              });
            }
            
            const { passed_problems: passed = 0, partial_passed_problems: partial = 0, failed_problems: failed = 0, total_problems: total = 0 } = results;
            const successRate = Math.round((passed + partial) / Math.max(total, 1) * 1000) / 10;
            
            let body = `## ğŸ“Š ë‹¤ì¤‘ ë¬¸ì œ í…ŒìŠ¤íŠ¸ ê²°ê³¼\n\n**ì „ì²´ ê²°ê³¼**: ${overall_result === 'PASS' ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'} (ì„±ê³µë¥ : ${successRate}%)\n\n| êµ¬ë¶„ | ì™„ì „ ì„±ê³µ | ë¶€ë¶„ ì„±ê³µ | ì‹¤íŒ¨ | ì „ì²´ |\n|:---:|:---:|:---:|:---:|:---:|\n| ê°œìˆ˜ | ${passed}ê°œ | ${partial}ê°œ | ${failed}ê°œ | ${total}ê°œ |\n\n`;
            
            if (results.details && results.details.length > 0) {
              body += `### ğŸ“ ë¬¸ì œë³„ ìƒì„¸ ê²°ê³¼\n\n`;
              for (const detail of results.details) {
                const statusEmoji = { 'PASS': 'âœ…', 'PARTIAL_PASS': 'âš ï¸', 'FAIL': 'âŒ', 'ERROR': 'ğŸ’¥' }[detail.result] || 'â“';
                body += `#### ${statusEmoji} ë¬¸ì œ ${detail.problem_id} (${detail.author})\n- **ê²°ê³¼**: ${detail.result}\n`;
                if (detail.sample_tests) body += `- **ìƒ˜í”Œ í…ŒìŠ¤íŠ¸**: ${detail.sample_tests.passed}/${detail.sample_tests.total} í†µê³¼\n`;
                if (detail.generated_tests) body += `- **ìƒì„± í…ŒìŠ¤íŠ¸**: ${detail.generated_tests.passed}/${detail.generated_tests.total} í†µê³¼\n`;
                if (detail.errors && detail.errors.length > 0) body += `- **ì˜¤ë¥˜**: \`${detail.errors[0]}\`\n`;
                body += `\n`;
              }
            }
            
            if (overall_result === 'PASS') {
              body += `### ğŸ‰ í…ŒìŠ¤íŠ¸ í†µê³¼!\n\ní•œ ë¬¸ì œ ì´ìƒì´ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ **PRì´ ìŠ¹ì¸ë©ë‹ˆë‹¤**. ì‹¤íŒ¨í•œ ë¬¸ì œë“¤ì€ BOJ ì‚¬ì´íŠ¸ì—ì„œ ì§ì ‘ í™•ì¸ í›„ ìˆ˜ì •í•´ì£¼ì„¸ìš”.\n\në¸Œëœì¹˜ë¥¼ ë³‘í•©í•˜ê³  ì‚­ì œí•´ì£¼ì„¸ìš”! ğŸš€`;
            } else {
              body += `### âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨\n\nëª¨ë“  ë¬¸ì œê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½”ë“œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”.\n\nğŸ’¡ **íŒ**: ê° ë¬¸ì œë³„ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ì—¬ ìˆ˜ì •í•´ë³´ì„¸ìš”.`;
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      # 15. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ (ë””ë²„ê·¸ìš©)
      - name: Upload test results
        if: always() && steps.check-validity.outputs.skip_tests == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.event.pull_request.number }}
          path: |
            test_results_summary.json
            problems_info.json
            problem_*_info.json
            tests_*.json
            sample_*_tests.json
          retention-days: 7

  # ë°ë“œë¼ì¸ ì•Œë¦¼ ì‘ì—…
  deadline-reminder:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      - name: Check deadlines and send reminders
        env:
          MATTERMOST_WEBHOOK_URL: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python scripts/deadline_checker.py
