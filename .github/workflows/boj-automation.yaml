# GitHub Actions ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: BOJ Study Automation (Gemini API)

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´
on:
  pull_request:
    branches: [main]
  schedule:
    - cron: "* * * * *"

# ì‹¤í–‰ë  ìž‘ì—…(Job) ëª©ë¡
jobs:
  # PR ê²€ì¦ ë° ìžë™ ë³‘í•© ìž‘ì—…
  test-and-merge:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    # ìž‘ì—…ì— í•„ìš”í•œ ê¶Œí•œ ì„¤ì •
    permissions:
      contents: write # README.md ì—…ë°ì´íŠ¸ ë° ì»¤ë°‹/í‘¸ì‹œë¥¼ ìœ„í•´ í•„ìš”
      pull-requests: write # PRì— í…ŒìŠ¤íŠ¸ ê²°ê³¼ ëŒ“ê¸€ì„ ìž‘ì„±í•˜ê¸° ìœ„í•´ í•„ìš”

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # PR ë¸Œëžœì¹˜ ìžì²´ë¥¼ ê°€ì ¸ì™€ 'Detached HEAD' ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤.
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.ref }}

      # 2. Python í™˜ê²½ ì„¤ì •
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # 3. Java í™˜ê²½ ì„¤ì •
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "11"

      # 4. Python ì˜ì¡´ì„± ì„¤ì¹˜ (Gemini API ê¸°ë°˜)
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-genai pytz beautifulsoup4 requests

        # 5. Gemini API í™˜ê²½ í…ŒìŠ¤íŠ¸ (ìµœì‹  ë²„ì „)
      - name: Test Gemini API environment
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ðŸ¤– Gemini 2.5-flash API í™˜ê²½ í…ŒìŠ¤íŠ¸..."
          echo "Python version: $(python --version)"
          
          # Gemini API í‚¤ í™•ì¸
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "âŒ GEMINI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          else
            echo "âœ… GEMINI_API_KEY ì„¤ì • í™•ì¸ë¨"
          fi
          
          # ì„¤ì¹˜ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
          echo "ðŸ“¦ ì„¤ì¹˜ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸..."
          pip list | grep -E "(google|genai)" || echo "âš ï¸ google ê´€ë ¨ íŒ¨í‚¤ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          
          # ë³„ë„ Python íŒŒì¼ ìƒì„± ë° ì‹¤í–‰
          echo "ðŸ“¦ google-genai ë¼ì´ë¸ŒëŸ¬ë¦¬ í…ŒìŠ¤íŠ¸..."
          cat > test_gemini_api.py << 'EOF'
          import os
          import sys

          print("ðŸ” Gemini 2.5-flash API ì—°ê²° í…ŒìŠ¤íŠ¸...")

          try:
              from google import genai
              from google.genai import types
              print("âœ… google-genai ë¼ì´ë¸ŒëŸ¬ë¦¬ import ì„±ê³µ")
              
              # í´ë¼ì´ì–¸íŠ¸ ì„¤ì • í…ŒìŠ¤íŠ¸
              client = genai.Client(api_key=os.environ["GEMINI_API_KEY"])
              print("âœ… Gemini 2.5-flash API í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì„±ê³µ")
              
              # ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ìš”ì²­
              print("ðŸ§ª ê°„ë‹¨í•œ API í…ŒìŠ¤íŠ¸ ìˆ˜í–‰...")
              config = types.GenerateContentConfig(
                  temperature=0.1,
                  max_output_tokens=100
              )
              
              response = client.models.generate_content(
                  model="gemini-2.5-flash",
                  contents="Hello, can you respond with just 'API_TEST_SUCCESS'?",
                  config=config
              )
              
              if hasattr(response, "text") and "API_TEST_SUCCESS" in response.text:
                  print("âœ… Gemini 2.5-flash API í…ŒìŠ¤íŠ¸ ì™„ë£Œ")
                  sys.exit(0)
              else:
                  text = response.text if hasattr(response, "text") else "No text"
                  print(f"âš ï¸ API ì‘ë‹µ í™•ì¸: {text}")
                  print("âœ… API ì—°ê²°ì€ ì„±ê³µí–ˆìœ¼ë‚˜ ì‘ë‹µ í˜•ì‹ì´ ì˜ˆìƒê³¼ ë‹¤ë¦„")
                  sys.exit(0)
                  
          except ImportError as e:
              print(f"âŒ google-genai ë¼ì´ë¸ŒëŸ¬ë¦¬ import ì‹¤íŒ¨: {e}")
              print("ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ì„¤ì¹˜í•˜ì„¸ìš”: pip install google-genai")
              sys.exit(1)
          except Exception as e:
              print(f"âŒ Gemini 2.5-flash API ì—°ê²° ì‹¤íŒ¨: {e}")
              print("API í‚¤ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.")
              sys.exit(1)
          EOF
              
              # Python íŒŒì¼ ì‹¤í–‰
              python test_gemini_api.py
              
              # ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸
              echo "ðŸ“¡ ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸..."
              curl -I https://generativelanguage.googleapis.com/ --max-time 10 || echo "âš ï¸ Gemini API ì—”ë“œí¬ì¸íŠ¸ ì§ì ‘ ì ‘ê·¼ ì œí•œë¨"
              curl -I https://solved.ac/ --max-time 10 || echo "âš ï¸ solved.ac ì ‘ê·¼ ì œí•œë¨"


      
      # 6. PRì—ì„œ ë¬¸ì œ ë° ì½”ë“œ ì •ë³´ ì¶”ì¶œ (GitHub API ì‚¬ìš©ìœ¼ë¡œ ë³€ê²½)
      - name: Extract problem and code info
        id: extract-info
        run: python scripts/extract_pr_info.py # ìŠ¤í¬ë¦½íŠ¸ ë‚´ë¶€ì—ì„œ APIë¥¼ í˜¸ì¶œí•˜ë„ë¡ ë³€ê²½
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 7. íŒŒì¼ êµ¬ì¡° ë° ìœ íš¨ì„± í™•ì¸
      - name: Check valid problems
        id: check-validity
        run: |
          HAS_VALID_PROBLEMS="${{ steps.extract-info.outputs.has_valid_problems }}"
          PROBLEM_ID="${{ steps.extract-info.outputs.problem_id }}"

          if [ "$HAS_VALID_PROBLEMS" = "false" ] || [ "$PROBLEM_ID" = "0000" ]; then
            echo "skip_tests=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ ë¶„ì„í•  ìˆ˜ ìžˆëŠ” ìœ íš¨í•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤."
          else
            echo "skip_tests=false" >> $GITHUB_OUTPUT
            echo "âœ… ìœ íš¨í•œ ë¬¸ì œë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤. Gemini API ì›¹ ê²€ìƒ‰ì„ ì‹œìž‘í•©ë‹ˆë‹¤."
          fi

      # 8. Gemini 2.5-flash APIë¡œ ë°±ì¤€ ë¬¸ì œ ì •ë³´ ê²€ìƒ‰ (ê°•í™”ëœ ìž¬ì‹œë„ ë¡œì§)
      - name: Search BOJ problem information with Gemini 2.5-flash
        if: steps.check-validity.outputs.skip_tests == 'false'
        id: search-problem
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          PROBLEM_ID="${{ steps.extract-info.outputs.problem_id }}"
          echo "ðŸ¤– Gemini 2.5-flashë¡œ ë¬¸ì œ $PROBLEM_ID ì •ë³´ ê²€ìƒ‰ ì‹œìž‘..."
          
          # ì—¬ëŸ¬ ë²ˆ ìž¬ì‹œë„ (ìµœì‹  APIëŠ” ë” ì•ˆì •ì ì´ë¯€ë¡œ ìž¬ì‹œë„ ê°„ê²© ë‹¨ì¶•)
          SUCCESS=false
          for attempt in {1..3}; do
            echo "ðŸš€ Gemini 2.5-flash ê²€ìƒ‰ ì‹œë„ $attempt/3..."
            
            if python scripts/fetch_boj_problem.py --problem-id $PROBLEM_ID; then
              echo "âœ… Gemini 2.5-flash ì›¹ ê²€ìƒ‰ ì„±ê³µ!"
              echo "search_success=true" >> $GITHUB_OUTPUT
              SUCCESS=true
              break
            else
              echo "âŒ Gemini ê²€ìƒ‰ ì‹œë„ $attempt ì‹¤íŒ¨"
              if [ $attempt -lt 3 ]; then
                echo "â³ 15ì´ˆ í›„ ìž¬ì‹œë„..."
                sleep 15
              fi
            fi
          done
          
          if [ "$SUCCESS" = "false" ]; then
            echo "ðŸ’¥ ëª¨ë“  Gemini 2.5-flash ê²€ìƒ‰ ì‹œë„ ì‹¤íŒ¨"
            echo "search_success=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      # 9. Gemini ê²€ìƒ‰ ì‹¤íŒ¨ ì‹œ ëŒ€ì•ˆ ì²˜ë¦¬
      - name: Handle Gemini search failure
        if: steps.check-validity.outputs.skip_tests == 'false' && steps.search-problem.outputs.search_success != 'true'
        run: |
          PROBLEM_ID="${{ steps.extract-info.outputs.problem_id }}"
          echo "ðŸ› ï¸ Gemini ê²€ìƒ‰ ì‹¤íŒ¨ë¡œ ì¸í•œ ëŒ€ì•ˆ ì²˜ë¦¬..."
          
          # solved.ac APIë§Œìœ¼ë¡œ ê¸°ë³¸ ì •ë³´ ìˆ˜ì§‘ ì‹œë„
          echo "ðŸ“¡ solved.ac APIë¡œ ê¸°ë³¸ ì •ë³´ ìˆ˜ì§‘ ì‹œë„..."
          python -c "
          import requests
          import json
          
          try:
              url = f'https://solved.ac/api/v3/problem/show?problemId=$PROBLEM_ID'
              response = requests.get(url, timeout=15)
              if response.status_code == 200:
                  data = response.json()
                  tags = []
                  for tag_data in data.get('tags', []):
                      korean_name = next((d['name'] for d in tag_data.get('displayNames', []) if d['language'] == 'ko'), None)
                      if korean_name:
                          tags.append(korean_name)
                  
                  problem_info = {
                      'problem_id': '$PROBLEM_ID',
                      'title': data.get('titleKo', 'ë¬¸ì œ $PROBLEM_ID'),
                      'level': data.get('level', 'N/A'),
                      'tags': tags,
                      'description': f'Gemini ê²€ìƒ‰ ì‹¤íŒ¨ë¡œ ì¸í•´ ë¬¸ì œ ì„¤ëª…ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. https://www.acmicpc.net/problem/$PROBLEM_ID ì—ì„œ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.',
                      'input_format': 'ìž…ë ¥ í˜•ì‹ì„ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.',
                      'output_format': 'ì¶œë ¥ í˜•ì‹ì„ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.',
                      'limits': 'ì‹œê°„/ë©”ëª¨ë¦¬ ì œí•œì„ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.',
                      'hint': '',
                      'samples': []
                  }
                  
                  with open('problem_info.json', 'w', encoding='utf-8') as f:
                      json.dump(problem_info, f, ensure_ascii=False, indent=2)
                  print('âœ… solved.ac ê¸°ë³¸ ì •ë³´ ìˆ˜ì§‘ ì™„ë£Œ')
              else:
                  raise Exception(f'API ì‘ë‹µ ì½”ë“œ: {response.status_code}')
          except Exception as e:
              print(f'âš ï¸ solved.ac API ì‹¤íŒ¨: {e}')
              # ìµœì†Œí•œì˜ ì •ë³´ë¼ë„ ì œê³µ
              problem_info = {
                  'problem_id': '$PROBLEM_ID',
                  'title': 'ë¬¸ì œ $PROBLEM_ID',
                  'level': 'N/A',
                  'tags': [],
                  'description': 'API ê²€ìƒ‰ ì‹¤íŒ¨ë¡œ ì¸í•´ ë¬¸ì œ ì„¤ëª…ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. https://www.acmicpc.net/problem/$PROBLEM_ID ì—ì„œ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.',
                  'input_format': 'ìž…ë ¥ í˜•ì‹ì„ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.',
                  'output_format': 'ì¶œë ¥ í˜•ì‹ì„ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.',
                  'limits': 'ì‹œê°„/ë©”ëª¨ë¦¬ ì œí•œì„ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.',
                  'hint': '',
                  'samples': []
              }
              with open('problem_info.json', 'w', encoding='utf-8') as f:
                  json.dump(problem_info, f, ensure_ascii=False, indent=2)
              print('âš ï¸ ìµœì†Œí•œì˜ ì •ë³´ íŒŒì¼ ìƒì„±')
          "
          
          # ë¹ˆ ìƒ˜í”Œ í…ŒìŠ¤íŠ¸ íŒŒì¼ ìƒì„±
          cat > sample_tests.json << EOF
          {
            "problem_id": "$PROBLEM_ID",
            "test_cases": []
          }
          EOF
          
          echo "âš ï¸ ëŒ€ì•ˆ ì •ë³´ íŒŒì¼ ìƒì„± ì™„ë£Œ"

      # 10. ê²€ìƒ‰ ê²°ê³¼ í™•ì¸ ë° ê²€ì¦
      - name: Verify search results
        if: steps.check-validity.outputs.skip_tests == 'false'
        run: |
          echo "ðŸ“Š Gemini ê²€ìƒ‰ ê²°ê³¼ ê²€ì¦..."
          
          if [ -f problem_info.json ]; then
            echo "âœ… problem_info.json íŒŒì¼ ì¡´ìž¬"
            echo "ðŸ“„ problem_info.json ë‚´ìš©:"
            cat problem_info.json | python -m json.tool | head -20
          else
            echo "âŒ problem_info.json íŒŒì¼ ì—†ìŒ"
          fi
          
          if [ -f sample_tests.json ]; then
            echo "âœ… sample_tests.json íŒŒì¼ ì¡´ìž¬"
            echo "ðŸ“„ sample_tests.json ë‚´ìš©:"
            cat sample_tests.json | python -m json.tool
          else
            echo "âŒ sample_tests.json íŒŒì¼ ì—†ìŒ"
          fi

      # 11. Gemini 2.5-flash APIë¡œ ë°˜ë¡€ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ìƒì„±
      - name: Generate test cases with Gemini 2.5-flash
        if: steps.check-validity.outputs.skip_tests == 'false'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ðŸ¤– Gemini 2.5-flashë¡œ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ìƒì„± ì¤‘..."
          python scripts/gemini_test_generator.py \
            --problem-id ${{ steps.extract-info.outputs.problem_id }} \
            --code-file ${{ steps.extract-info.outputs.code_file }} \
            --language ${{ steps.extract-info.outputs.language }} \
            --problem-info problem_info.json


      # 12. ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Run all tests
        if: steps.check-validity.outputs.skip_tests == 'false'
        id: run-tests
        run: |
          echo "ðŸ§ª ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
          python scripts/test_runner.py \
            --code-file ${{ steps.extract-info.outputs.code_file }} \
            --language ${{ steps.extract-info.outputs.language }} \
            --sample-tests sample_tests.json \
            --generated-tests generated_tests.json

      # 13. í…ŒìŠ¤íŠ¸ í†µê³¼ ì‹œ README.md ì—…ë°ì´íŠ¸
      - name: Update README on success
        if: steps.run-tests.outputs.result == 'PASS'
        run: |
          echo "ðŸ“ README.md ì—…ë°ì´íŠ¸ ì¤‘..."
          python scripts/update_readme.py \
            --problem-id ${{ steps.extract-info.outputs.problem_id }} \
            --author ${{ steps.extract-info.outputs.author }} \
            --submission-date $(date '+%Y-%m-%d') \
            --language ${{ steps.extract-info.outputs.language }}

      # 14. README.md ë³€ê²½ì‚¬í•­ì„ PR ë¸Œëžœì¹˜ì— ì»¤ë°‹ ë° í‘¸ì‹œ
      - name: Commit and Push README changes
        if: steps.run-tests.outputs.result == 'PASS'
        run: |
          git config --local user.email "${{ github.event.pull_request.user.login }}@users.noreply.github.com"
          git config --local user.name "${{ github.event.pull_request.user.login }}"
          git add README.md
          if ! git diff --cached --quiet; then
            git commit -m "ðŸ“Š Update progress: Problem ${{ steps.extract-info.outputs.problem_id }} solved by ${{ steps.extract-info.outputs.author }}"
            git push origin ${{ github.event.pull_request.head.ref }}
          else
            echo "README.mdì— ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ì»¤ë°‹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          fi

      # 15. Gemini ê²€ìƒ‰ ì„±ê³µ ì‹œ Mattermost ì•Œë¦¼ (2.5-flash ì •ë³´ í¬í•¨)
      - name: Send success notification with Gemini 2.5-flash info
        if: steps.run-tests.outputs.result == 'PASS'
        run: |
          PROBLEM_ID="${{ steps.extract-info.outputs.problem_id }}"
          AUTHOR="${{ steps.extract-info.outputs.author }}"
          LANGUAGE="${{ steps.extract-info.outputs.language }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          SEARCH_SUCCESS="${{ steps.search-problem.outputs.search_success }}"
          
          # ê²€ìƒ‰ ìƒíƒœì— ë”°ë¥¸ ë©”ì‹œì§€ ì¡°ì •
          if [ "$SEARCH_SUCCESS" = "true" ]; then
            SEARCH_STATUS="ðŸ¤– Gemini 2.5-flash ì›¹ ê²€ìƒ‰ ì„±ê³µ"
          else
            SEARCH_STATUS="âš ï¸ Gemini ê²€ìƒ‰ ì‹¤íŒ¨ (ëŒ€ì•ˆ ì •ë³´ ì‚¬ìš©)"
          fi

          cat > payload.json << EOF
          {
            "username": "BOJ-Bot",
            "icon_emoji": ":white_check_mark:",
            "text": "ðŸŽ‰ **Test Passed!**\\n\\n**Problem**: ${PROBLEM_ID}\\n**Solver**: ${AUTHOR}\\n**Language**: ${LANGUAGE}\\n**AI**: ${SEARCH_STATUS}\\n**Model**: Gemini 2.5-flash\\n**PR**: ${PR_URL}\\n\\nâœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤!"
          }
          EOF

              curl -X POST \
                -H "Content-Type: application/json" \
                -d @payload.json \
                "${{ secrets.MATTERMOST_WEBHOOK_URL }}" \
                --fail --silent --show-error

      # 16. í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ìƒì„¸ ì•Œë¦¼ (2.5-flash ì •ë³´ í¬í•¨)
      - name: Send failure notification with Gemini 2.5-flash details
        if: steps.run-tests.outputs.result == 'FAIL'
        run: |
          PROBLEM_ID="${{ steps.extract-info.outputs.problem_id }}"
          AUTHOR="${{ steps.extract-info.outputs.author }}"
          LANGUAGE="${{ steps.extract-info.outputs.language }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          SEARCH_SUCCESS="${{ steps.search-problem.outputs.search_success }}"

          ERROR_DETAILS="${{ steps.run-tests.outputs.details }}"
          ERROR_DETAILS=$(echo "$ERROR_DETAILS" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed 's/`/\\`/g')

          # ê²€ìƒ‰ ìƒíƒœ ì¶”ê°€
          if [ "$SEARCH_SUCCESS" = "true" ]; then
            SEARCH_INFO="ðŸ¤– Gemini 2.5-flash: ì„±ê³µ"
          else
            SEARCH_INFO="âš ï¸ Gemini ê²€ìƒ‰: ì‹¤íŒ¨ (ê¸°ë³¸ ì •ë³´ë¡œ í…ŒìŠ¤íŠ¸)"
          fi
          
          cat > payload.json << EOF
          {
            "username": "BOJ-Bot",
            "icon_emoji": ":x:",
            "text": "âŒ **Test Failed!**\\n\\n**Problem**: ${PROBLEM_ID}\\n**Submitter**: ${AUTHOR}\\n**Language**: ${LANGUAGE}\\n**AI**: ${SEARCH_INFO}\\n**Model**: Gemini 2.5-flash\\n**PR**: ${PR_URL}\\n\\n**Error Details:**\\n\`\`\`\\n${ERROR_DETAILS}\\n\`\`\`\\n\\nðŸ’ª ì½”ë“œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”!"
          }
          EOF

          curl -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "${{ secrets.MATTERMOST_WEBHOOK_URL }}" \
            --fail --silent --show-error


      # 17. PRì— í…ŒìŠ¤íŠ¸ ê²°ê³¼ ëŒ“ê¸€ ìž‘ì„± (Gemini 2.5-flash ì •ë³´ í¬í•¨)
      - name: Comment test results with Gemini 2.5-flash status
        if: always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { result, details } = ${{ toJSON(steps.run-tests.outputs) }};
            const { 
              author, 
              problem_id,
              has_valid_problems,
              problems_summary,
              total_problems_count,
              is_multiple_problems
            } = ${{ toJSON(steps.extract-info.outputs) }};
            
            const searchSuccess = "${{ steps.search-problem.outputs.search_success }}";

            // ìœ íš¨í•œ ë¬¸ì œê°€ ì—†ëŠ” ê²½ìš°  
            if (has_valid_problems === 'false' || problem_id === '0000') {
              const body = `## ðŸ“ ë¶„ì„í•  ìˆ˜ ìžˆëŠ” ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤

            **${author}**ë‹˜ì˜ PRì—ì„œ ë¶„ì„í•  ìˆ˜ ìžˆëŠ” Main.java íŒŒì¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.

            **í™•ì¸ ì‚¬í•­:**
            - íŒŒì¼ ê²½ë¡œê°€ \`ë³¸ì¸ì´ë¦„/ë¬¸ì œë²ˆí˜¸/Main.java\` í˜•ì‹ìœ¼ë¡œ ìž‘ì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”
            - ì‹¤ì œë¡œ ë³€ê²½ì‚¬í•­ì´ ìžˆëŠ” íŒŒì¼ì¸ì§€ í™•ì¸í•˜ì„¸ìš”
            - PRì— ë³¸ì¸ì˜ íŒŒì¼ë§Œ í¬í•¨ë˜ì–´ ìžˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”

            ${problems_summary}

            ì˜¬ë°”ë¥¸ í˜•ì‹ìœ¼ë¡œ íŒŒì¼ì„ ì¶”ê°€í•œ í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”! ðŸ“`;
                              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
              return;
            }

            // Gemini 2.5-flash ê²€ìƒ‰ ìƒíƒœ ë©”ì‹œì§€ ìƒì„±
            let searchStatusEmoji = "";
            let searchStatusText = "";
            
            if (searchSuccess === 'true') {
              searchStatusEmoji = "ðŸ¤–";
              searchStatusText = "Gemini 2.5-flash ì›¹ ê²€ìƒ‰ ì„±ê³µ";
            } else {
              searchStatusEmoji = "âš ï¸";
              searchStatusText = "Gemini ê²€ìƒ‰ ì‹¤íŒ¨ (ê¸°ë³¸ ì •ë³´ë¡œ í…ŒìŠ¤íŠ¸ ì§„í–‰)";
            }

            // ì •ìƒì ì¸ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì²˜ë¦¬
            let body;
            
            // ì—¬ëŸ¬ ë¬¸ì œ ë³€ê²½ ì‹œ í—¤ë” ì¶”ê°€
            const multiProblemHeader = is_multiple_problems === 'true' ? 
              `## ðŸ“Š ë‹¤ì¤‘ ë¬¸ì œ ë³€ê²½ ê°ì§€ (ì´ ${total_problems_count}ê°œ)
              
            ${problems_summary}

            **í˜„ìž¬ í…ŒìŠ¤íŠ¸**: ë¬¸ì œ ${problem_id} (ìš°ì„ ìˆœìœ„ ìµœìƒìœ„)

            ---

            ` : '';

            if (result === 'PASS') {
              body = `${multiProblemHeader}## âœ… í…ŒìŠ¤íŠ¸ í†µê³¼!

            ðŸŽ‰ **${author}**ë‹˜ì˜ ë¬¸ì œ **${problem_id}** í•´ê²°ì„ ì¶•í•˜í•©ë‹ˆë‹¤!

            **í…ŒìŠ¤íŠ¸ ê²°ê³¼:**
            - âœ… ìƒ˜í”Œ í…ŒìŠ¤íŠ¸: í†µê³¼
            - ðŸ¤– AI ìƒì„± ë°˜ë¡€ í…ŒìŠ¤íŠ¸: í†µê³¼  
            - ${searchStatusEmoji} AI ê²€ìƒ‰: ${searchStatusText}
            - ðŸ§  AI ëª¨ë¸: Gemini 2.5-flash
            - ðŸ“Š README.mdê°€ ìžë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.

            ${is_multiple_problems === 'true' ? 
              `ðŸ’¡ **ì°¸ê³ **: ì´ë²ˆ PRì—ì„œ ë³€ê²½ëœ ë‹¤ë¥¸ ë¬¸ì œë“¤ë„ ë™ì¼í•˜ê²Œ ê²€ì¦ë˜ì—ˆì„ ê²ƒìœ¼ë¡œ ê°„ì£¼ë©ë‹ˆë‹¤.` : 
              ''}

            ë¸Œëžœì¹˜ ë³‘í•©í•˜ê³  ì‚­ì œí•´ì£¼ì„¸ìš”! ðŸš€`;

            } else {
              body = `${multiProblemHeader}## âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨

            **${author}**ë‹˜ì˜ ë¬¸ì œ **${problem_id}** ì½”ë“œì—ì„œ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤:

            **í…ŒìŠ¤íŠ¸ ìƒíƒœ:**
            - ${searchStatusEmoji} AI ê²€ìƒ‰: ${searchStatusText}
            - ðŸ§  AI ëª¨ë¸: Gemini 2.5-flash
            
            **ì˜¤ë¥˜ ë‚´ìš©:**
            \`\`\`
            ${details}
            \`\`\`

            ${searchSuccess !== 'true' ? 
              `âš ï¸ **Gemini ê²€ìƒ‰ ì‹¤íŒ¨ ì•ˆë‚´**: AI ì›¹ ê²€ìƒ‰ìœ¼ë¡œ ë¬¸ì œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒ˜í”Œ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ê°€ ë¶€ì¡±í•  ìˆ˜ ìžˆìœ¼ë‹ˆ ì§ì ‘ í™•ì¸ í›„ ì œì¶œí•´ì£¼ì„¸ìš”.` : 
              ''}

            ${is_multiple_problems === 'true' ? 
              `ðŸ’¡ **ì°¸ê³ **: ìš°ì„ ìˆœìœ„ê°€ ê°€ìž¥ ë†’ì€ ë¬¸ì œë¶€í„° í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤. ì´ ë¬¸ì œë¥¼ í•´ê²°í•œ í›„ ë‹¤ì‹œ í‘¸ì‹œí•˜ë©´ ë‹¤ë¥¸ ë¬¸ì œë“¤ë„ í•¨ê»˜ ê²€ì¦ë©ë‹ˆë‹¤.` :  
              ''}

            ì½”ë“œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”! ðŸ’ª`;
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number, 
              owner: context.repo.owner, 
              repo: context.repo.repo, 
              body: body
            });

      # 18. Gemini 2.5-flash ê²€ìƒ‰ ê²°ê³¼ ì—…ë¡œë“œ (ë””ë²„ê·¸ìš©)
      - name: Upload Gemini 2.5-flash search results
        if: always() && steps.check-validity.outputs.skip_tests == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: gemini-2.5-flash-results-${{ steps.extract-info.outputs.problem_id }}
          path: |
            problem_info.json
            sample_tests.json
            generated_tests.json
          retention-days: 7

      # 19. ë‹¤ì¤‘ ë¬¸ì œ ì•Œë¦¼ (Mattermost)
      - name: Send multiple problems notification
        if: steps.extract-info.outputs.multiple_problems == 'true'
        run: |
          PROBLEMS_COUNT="${{ steps.extract-info.outputs.problems_count }}"
          AUTHOR="${{ steps.extract-info.outputs.author }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_URL="${{ github.event.pull_request.html_url }}"

          cat > payload.json << EOF
          {
            "username": "BOJ-Bot",
            "icon_emoji": ":warning:",
            "text": "âš ï¸ **ë‹¤ì¤‘ ë¬¸ì œ ì œì¶œ ê°ì§€**\\n\\n**${AUTHOR}**ë‹˜ì´ PR #${PR_NUMBER}ì—ì„œ ${PROBLEMS_COUNT}ê°œì˜ ë¬¸ì œë¥¼ ë™ì‹œì— ì œì¶œí–ˆìŠµë‹ˆë‹¤.\\n\\nðŸ’¡ **ê¶Œìž¥ì‚¬í•­**: ë¬¸ì œë³„ë¡œ ê°œë³„ PRì„ ë§Œë“¤ì–´ ì£¼ì„¸ìš”!\\n\\nPR ë§í¬: ${PR_URL}"
          }
          EOF

          curl -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "${{ secrets.MATTERMOST_WEBHOOK_URL }}" \
            --fail --silent --show-error

  # ë°ë“œë¼ì¸ ì•Œë¦¼ ìž‘ì—…
  deadline-reminder:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      - name: Check deadlines and send reminders
        env:
          MATTERMOST_WEBHOOK_URL: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python scripts/deadline_checker.py