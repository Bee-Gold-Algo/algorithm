name: Weekly Study Update (Debug Mode - Scripts)
on:
  schedule:
    # ë””ë²„ê·¸ìš©: ë§¤ 5ë¶„ë§ˆë‹¤ ì‹¤í–‰ (GitHub Actions ìµœì†Œ ê°„ê²©)
    - cron: "*/5 * * * *"
  workflow_dispatch:
    inputs:
      force_reset:
        description: 'ê°•ì œ ë¦¬ì…‹ (ìƒˆ ì£¼ì°¨ê°€ ì•„ë‹ˆì–´ë„ ì‹¤í–‰)'
        required: false
        default: true  # ë””ë²„ê·¸ìš©ìœ¼ë¡œ ê¸°ë³¸ê°’ true
        type: boolean
      notification:
        description: 'ì•Œë¦¼ ì „ì†¡ ì—¬ë¶€'
        required: false
        default: false  # ë””ë²„ê·¸ìš©ìœ¼ë¡œ ê¸°ë³¸ê°’ false (ì•Œë¦¼ ìŠ¤íŒ¸ ë°©ì§€)
        type: boolean
      debug_mode:
        description: 'ë””ë²„ê·¸ ëª¨ë“œ (ìƒì„¸ ë¡œê·¸ ì¶œë ¥)'
        required: false
        default: true
        type: boolean

env:
  TZ: Asia/Seoul
  DEBUG_MODE: true  # ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”
  FORCE_RESET: true # ë””ë²„ê·¸ìš©ìœ¼ë¡œ í•­ìƒ ê°•ì œ ë¦¬ì…‹

jobs:
  debug-weekly-update:
    runs-on: ubuntu-latest
    steps:
      - name: Debug Info
        run: |
          echo "ğŸ› DEBUG MODE: ë§¤ 5ë¶„ë§ˆë‹¤ ì‹¤í–‰ë˜ëŠ” í…ŒìŠ¤íŠ¸ ì›Œí¬í”Œë¡œìš° (Scripts ë²„ì „)"
          echo "â° ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
          echo "ğŸ”§ íŠ¸ë¦¬ê±°: ${{ github.event_name }}"
          echo "ğŸ‘¤ ì‹¤í–‰ì: ${{ github.actor }}"
          
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
          
      - name: Install dependencies
        run: |
          pip install requests pytz
          echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
          
      - name: Debug - Check files structure
        run: |
          echo "ğŸ“ íŒŒì¼ êµ¬ì¡° í™•ì¸:"
          echo "=== Root Directory ==="
          ls -la
          echo ""
          echo "=== Scripts Directory ==="
          if [ -d "scripts" ]; then
            ls -la scripts/
          else
            echo "âŒ scripts ë””ë ‰í† ë¦¬ ì—†ìŒ"
          fi
          echo ""
          echo "=== Python Scripts Check ==="
          for script in scripts/check_session.py scripts/send_notification.py scripts/create_debug_readme.py; do
            if [ -f "$script" ]; then
              echo "âœ… $script ì¡´ì¬"
            else
              echo "âŒ $script ì—†ìŒ"
            fi
          done
          
      - name: Check current session info using script
        id: session_check
        run: |
          echo "ğŸ” íšŒì°¨ ì •ë³´ í™•ì¸ ì¤‘ (ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©)..."
          
          # check_session.pyê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì‹¤í–‰
          if [ -f "scripts/check_session.py" ]; then
            echo "ğŸ“ scripts/check_session.py ì‹¤í–‰ ì¤‘..."
            
            # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰í•˜ê³  ê²°ê³¼ë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ì €ì¥
            cd scripts
            RESULT=$(python check_session.py 2>&1)
            cd ..
            
            echo "ğŸ“‹ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê²°ê³¼:"
            echo "$RESULT"
            
            # ê²°ê³¼ë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •
            echo "$RESULT" | grep "=" >> $GITHUB_ENV
            
            echo "âœ… check_session.py ì‹¤í–‰ ì™„ë£Œ"
          else
            echo "âŒ scripts/check_session.py ì—†ìŒ - í´ë°± ëª¨ë“œ"
            
            # í´ë°±: ê¸°ë³¸ê°’ ì„¤ì •
            TODAY=$(date '+%Y-%m-%d')
            WEEK_END=$(date -d '+6 days' '+%Y-%m-%d')
            
            echo "IS_NEW_WEEK=true" >> $GITHUB_ENV
            echo "SESSION_NUMBER=999" >> $GITHUB_ENV
            echo "TODAY=$TODAY" >> $GITHUB_ENV
            echo "WEEK_START=$TODAY" >> $GITHUB_ENV
            echo "WEEK_END=$WEEK_END" >> $GITHUB_ENV
            echo "DEADLINE=$WEEK_END 23:59" >> $GITHUB_ENV
            echo "HAS_SESSION_COUNTER=false" >> $GITHUB_ENV
            echo "TOTAL_WEEKS=0" >> $GITHUB_ENV
            echo "TOTAL_DAYS=0" >> $GITHUB_ENV
            echo "STUDY_START=$TODAY" >> $GITHUB_ENV
          fi
          
      - name: Debug - Show environment variables
        if: github.event.inputs.debug_mode == 'true' || env.DEBUG_MODE == 'true'
        run: |
          echo "ğŸ› í™˜ê²½ ë³€ìˆ˜ í™•ì¸:"
          echo "  IS_NEW_WEEK: $IS_NEW_WEEK"
          echo "  FORCE_RESET: $FORCE_RESET"
          echo "  SESSION_NUMBER: $SESSION_NUMBER"
          echo "  TODAY: $TODAY"
          echo "  WEEK_START: $WEEK_START"
          echo "  WEEK_END: $WEEK_END"
          echo "  DEADLINE: $DEADLINE"
          echo "  HAS_SESSION_COUNTER: $HAS_SESSION_COUNTER"
          echo "  TOTAL_WEEKS: $TOTAL_WEEKS"
          echo "  TOTAL_DAYS: $TOTAL_DAYS"
          
      - name: Create README backup
        run: |
          if [ -f "README.md" ]; then
            BACKUP_NAME="README_debug_backup_$(date +%Y%m%d_%H%M%S).md"
            cp README.md "$BACKUP_NAME"
            echo "ğŸ“ ë””ë²„ê·¸ ë°±ì—… ìƒì„±: $BACKUP_NAME"
            echo "BACKUP_FILE=$BACKUP_NAME" >> $GITHUB_ENV
          else
            echo "â„¹ï¸ ê¸°ì¡´ README.md ì—†ìŒ"
          fi
          
      - name: Generate README using script
        run: |
          echo "ğŸ”„ README ìƒì„± ì¤‘ (ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©)..."
          
          if [ -f "scripts/create_debug_readme.py" ]; then
            echo "ğŸ“ scripts/create_debug_readme.py ì‹¤í–‰ ì¤‘..."
            
            cd scripts
            if [ "$DEBUG_MODE" = "true" ]; then
              python create_debug_readme.py --debug-mode --try-advanced
            else
              python create_debug_readme.py --try-advanced
            fi
            cd ..
            
            if [ $? -eq 0 ]; then
              echo "âœ… ìŠ¤í¬ë¦½íŠ¸ë¥¼ í†µí•œ README ìƒì„± ì„±ê³µ"
              echo "UPDATE_SUCCESS=true" >> $GITHUB_ENV
            else
              echo "âŒ ìŠ¤í¬ë¦½íŠ¸ë¥¼ í†µí•œ README ìƒì„± ì‹¤íŒ¨"
              echo "UPDATE_SUCCESS=false" >> $GITHUB_ENV
            fi
          else
            echo "âŒ scripts/create_debug_readme.py ì—†ìŒ - ê°„ë‹¨ README ìƒì„±"
            
            # í´ë°±: ê°„ë‹¨í•œ README ìƒì„± (HERE document ëŒ€ì‹  echo ì‚¬ìš©)
            echo "# ğŸš€ ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë”” (Debug Mode - Fallback)" > README.md
            echo "" >> README.md
            echo "## ğŸ“… ${SESSION_NUMBER}íšŒì°¨ í˜„í™©" >> README.md
            echo "**ê¸°ê°„**: ${WEEK_START} ~ ${WEEK_END}" >> README.md
            echo "**ë§ˆê°**: ${DEADLINE}" >> README.md
            echo "" >> README.md
            echo "### âš ï¸ í´ë°± ëª¨ë“œë¡œ ì‹¤í–‰ë¨" >> README.md
            echo "" >> README.md
            echo "scripts/create_debug_readme.py íŒŒì¼ì´ ì—†ì–´ì„œ ê¸°ë³¸ READMEë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤." >> README.md
            echo "" >> README.md
            echo "### ğŸ› ë””ë²„ê·¸ ì •ë³´" >> README.md
            echo "- **ì‹¤í–‰ ì‹œê°„**: $(date '+%Y-%m-%d %H:%M:%S KST')" >> README.md
            echo "- **íšŒì°¨**: ${SESSION_NUMBER}íšŒì°¨" >> README.md
            echo "- **íŠ¸ë¦¬ê±°**: ${{ github.event_name }}" >> README.md
            echo "- **ì‹¤í–‰ì**: ${{ github.actor }}" >> README.md
            echo "" >> README.md
            echo "| ì°¸ê°€ì | ì›” | í™” | ìˆ˜ | ëª© | ê¸ˆ | í†  | ì¼ |" >> README.md
            echo "|--------|----|----|----|----|----|----|---|" >> README.md
            echo "| fallback_user | 1000 | | | | | | |" >> README.md
            echo "" >> README.md
            echo "---" >> README.md
            echo "*Auto-updated by GitHub Actions ğŸ¤– (Fallback Mode)*" >> README.md
            
            echo "âœ… í´ë°± README ìƒì„± ì™„ë£Œ"
            echo "UPDATE_SUCCESS=true" >> $GITHUB_ENV
          fi
          
      - name: Debug - Show generated README
        if: github.event.inputs.debug_mode == 'true' || env.DEBUG_MODE == 'true'
        run: |
          echo "ğŸ“„ ìƒì„±ëœ README.md ë‚´ìš© (ì²« 30ì¤„):"
          echo "================================================"
          head -30 README.md
          echo "================================================"
          echo "(ì´ $(wc -l < README.md) ì¤„, $(stat -c%s README.md) bytes)"
          
      - name: Commit changes
        if: env.UPDATE_SUCCESS == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action - Debug Scripts"
          
          # ë³€ê²½ëœ íŒŒì¼ë“¤ í™•ì¸
          git add README.md
          git add $BACKUP_FILE 2>/dev/null || true
          git add session_info.json 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "ğŸ“ ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
            echo "CHANGES_COMMITTED=false" >> $GITHUB_ENV
          else
            # ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ë³€ìˆ˜ì— ì €ì¥
            COMMIT_TIME=$(date '+%Y-%m-%d %H:%M:%S KST')
            SCRIPT_STATUS=$([ -f "scripts/create_debug_readme.py" ] && echo "ì‚¬ìš©" || echo "í´ë°±")
            
            git commit -m "ğŸ› DEBUG: ìŠ¤í¬ë¦½íŠ¸ ê¸°ë°˜ README ìë™ ì—…ë°ì´íŠ¸

            ğŸ• ì‹¤í–‰ ì‹œê°„: $COMMIT_TIME
            ğŸ¯ íšŒì°¨: ${SESSION_NUMBER}íšŒì°¨ (DEBUG)
            ğŸ¤– íŠ¸ë¦¬ê±°: ${{ github.event_name }}
            ğŸ‘¤ ì‹¤í–‰ì: ${{ github.actor }}
            ğŸ“ ìŠ¤í¬ë¦½íŠ¸: $SCRIPT_STATUS

            âš ï¸ ì´ê²ƒì€ 5ë¶„ë§ˆë‹¤ ì‹¤í–‰ë˜ëŠ” ë””ë²„ê·¸ ëª¨ë“œì…ë‹ˆë‹¤."
                        
                        git push
                        
                        echo "âœ… ë””ë²„ê·¸ ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ì™„ë£Œ"
                        echo "CHANGES_COMMITTED=true" >> $GITHUB_ENV
                      fi
                      
      - name: Send notification using script
        if: env.CHANGES_COMMITTED == 'true' && (github.event.inputs.notification == 'true' || env.FORCE_NOTIFICATION == 'true')
        env:
          YEOMIN4242_MATTERMOST_URL: ${{ secrets.YEOMIN4242_MATTERMOST_URL }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "ğŸ“¢ ì•Œë¦¼ ì „ì†¡ ì¤‘ (ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©)..."
          
          if [ -f "scripts/send_notification.py" ]; then
            echo "ğŸ“¨ scripts/send_notification.py ì‹¤í–‰ ì¤‘..."
            
            cd scripts
            if [ "$DEBUG_MODE" = "true" ]; then
              python send_notification.py --debug-mode --force-reset
            else
              python send_notification.py --force-reset
            fi
            cd ..
            
            if [ $? -eq 0 ]; then
              echo "âœ… ìŠ¤í¬ë¦½íŠ¸ë¥¼ í†µí•œ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ"
            else
              echo "âŒ ìŠ¤í¬ë¦½íŠ¸ë¥¼ í†µí•œ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
            fi
          else
            echo "âŒ scripts/send_notification.py ì—†ìŒ - ê¸°ë³¸ ì•Œë¦¼"
            
            # í´ë°±: ê°„ë‹¨í•œ curl ì•Œë¦¼
            if [ -n "$YEOMIN4242_MATTERMOST_URL" ]; then
              CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S KST')
              
              # JSON ë©”ì‹œì§€ êµ¬ì„± (ì‘ì€ë”°ì˜´í‘œë¡œ ê°ì‹¸ì„œ ì´ìŠ¤ì¼€ì´í”„ ë¬¸ì œ í•´ê²°)
              MESSAGE='ğŸ› **DEBUG: README ìë™ ì—…ë°ì´íŠ¸ (í´ë°±)**\n\nâ° ì‹œê°„: '"$CURRENT_TIME"'\nğŸ¯ íšŒì°¨: '"${SESSION_NUMBER}"'íšŒì°¨\nğŸ¤– íŠ¸ë¦¬ê±°: ${{ github.event_name }}\n\nâš ï¸ send_notification.py ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ì–´ì„œ ê¸°ë³¸ ì•Œë¦¼ì„ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.'
              
              curl -X POST "$YEOMIN4242_MATTERMOST_URL" \
                -H "Content-Type: application/json" \
                -d '{"text":"'"$MESSAGE"'"}' || echo "ê¸°ë³¸ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
            else
              echo "âš ï¸ Mattermost webhook URLì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ"
            fi
          fi
          
      - name: Debug summary
        if: always()
        run: |
          echo "## ğŸ› Debug Weekly Update ì‹¤í–‰ ê²°ê³¼ (Scripts)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**âš ï¸ ì£¼ì˜: ì´ê²ƒì€ 5ë¶„ë§ˆë‹¤ ì‹¤í–‰ë˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ ê¸°ë°˜ ë””ë²„ê·¸ ëª¨ë“œì…ë‹ˆë‹¤**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ì‹¤í–‰ ì‹œê°„**: $(date '+%Y-%m-%d %H:%M:%S KST')" >> $GITHUB_STEP_SUMMARY
          echo "**íŠ¸ë¦¬ê±°**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**ì‹¤í–‰ì**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š íšŒì°¨ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- **íšŒì°¨**: ${SESSION_NUMBER}íšŒì°¨ (DEBUG)" >> $GITHUB_STEP_SUMMARY
          echo "- **ë‚ ì§œ**: ${TODAY}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì£¼ì°¨**: ${WEEK_START} ~ ${WEEK_END}" >> $GITHUB_STEP_SUMMARY
          echo "- **Session Counter**: ${HAS_SESSION_COUNTER}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì™„ë£Œ ì£¼ì°¨**: ${TOTAL_WEEKS}ì£¼" >> $GITHUB_STEP_SUMMARY
          echo "- **ì´ ì§„í–‰ì¼**: ${TOTAL_DAYS}ì¼" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ ìŠ¤í¬ë¦½íŠ¸ ìƒíƒœ" >> $GITHUB_STEP_SUMMARY
          
          # ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ë“¤ í™•ì¸
          for script in check_session.py send_notification.py create_debug_readme.py; do
            if [ -f "scripts/$script" ]; then
              echo "âœ… **$script**: ì‚¬ìš© ê°€ëŠ¥" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **$script**: ì—†ìŒ (í´ë°± ëª¨ë“œ)" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ ì‘ì—… ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          
          if [ "$UPDATE_SUCCESS" = "true" ]; then
            echo "âœ… **README ì—…ë°ì´íŠ¸**: ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
            if [ "$CHANGES_COMMITTED" = "true" ]; then
              echo "âœ… **ì»¤ë°‹**: ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
            else
              echo "â„¹ï¸ **ì»¤ë°‹**: ë³€ê²½ì‚¬í•­ ì—†ìŒ" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **README ì—…ë°ì´íŠ¸**: ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$BACKUP_FILE" != "" ]; then
            echo "ğŸ“ **ë°±ì—…**: $BACKUP_FILE" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”§ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ìƒì„±" >> $GITHUB_STEP_SUMMARY
          echo "ë‹¤ìŒ ìŠ¤í¬ë¦½íŠ¸ë“¤ì„ \`scripts/\` ë””ë ‰í† ë¦¬ì— ì¶”ê°€í•˜ì„¸ìš”:" >> $GITHUB_STEP_SUMMARY
          echo "- \`check_session.py\`: íšŒì°¨ ì •ë³´ í™•ì¸" >> $GITHUB_STEP_SUMMARY
          echo "- \`create_debug_readme.py\`: README ìƒì„±" >> $GITHUB_STEP_SUMMARY
          echo "- \`send_notification.py\`: ì•Œë¦¼ ì „ì†¡" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”„ ì •ìƒ ëª¨ë“œ ì „í™˜" >> $GITHUB_STEP_SUMMARY
          echo "í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„:" >> $GITHUB_STEP_SUMMARY
          echo "1. cronì„ \`\"0 0 * * 1\"\` (ë§¤ì£¼ ì›”ìš”ì¼)ë¡œ ë³€ê²½" >> $GITHUB_STEP_SUMMARY
          echo "2. \`DEBUG_MODE: false\`ë¡œ ë³€ê²½" >> $GITHUB_STEP_SUMMARY
          echo "3. \`FORCE_RESET: false\`ë¡œ ë³€ê²½" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*ğŸ› ìŠ¤í¬ë¦½íŠ¸ ê¸°ë°˜ ë””ë²„ê·¸ ëª¨ë“œ - ë§¤ 5ë¶„ë§ˆë‹¤ ì‹¤í–‰*" >> $GITHUB_STEP_SUMMARY