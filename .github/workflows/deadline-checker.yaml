name: Algorithm Study Deadline Checker and Weekly Reset
on:
  schedule:
    # ê¸°ì¡´ ìŠ¤ì¼€ì¤„
    - cron: "0 0 * * 5" # ê¸ˆìš”ì¼ ì˜¤ì „ 9ì‹œ KST (5ì¼ì°¨ ì²´í¬)
    - cron: "0 0 * * 0" # ì¼ìš”ì¼ ì˜¤ì „ 9ì‹œ KST (ë§ˆê°ì¼ ì•Œë¦¼)
    - cron: "0 12 * * 0" # ì¼ìš”ì¼ ì˜¤í›„ 9ì‹œ KST (ìµœì¢… ë§ˆê°)
    
    # ìƒˆ ì£¼ì°¨ ì‹œì‘ ìŠ¤ì¼€ì¤„ (ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ)
    - cron: "0 0 * * 1" # ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ KST (ìƒˆ ì£¼ì°¨ ì‹œì‘)
    
  workflow_dispatch:
    inputs:
      action:
        description: 'ì‹¤í–‰í•  ì‘ì—…'
        required: true
        default: 'check'
        type: choice
        options:
        - check
        - reset

jobs:
  # ê¸°ì¡´ ë§ˆê°ì¼ ì²´í¬ ì‘ì—…
  check-deadline:
    runs-on: ubuntu-latest
    if: github.event.schedule != '0 0 * * 1' && (github.event_name != 'workflow_dispatch' || github.event.inputs.action == 'check')
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
      - name: Install dependencies
        run: |
          pip install requests pytz
      - name: Run deadline checker
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          YEOMIN4242_MATTERMOST_URL: ${{ secrets.YEOMIN4242_MATTERMOST_URL }}
          # ë‹¤ë¥¸ ì°¸ê°€ìë“¤ë„ í•„ìš”ì— ë”°ë¼ ì¶”ê°€
        run: python scripts/deadline_checker.py

  # ìƒˆë¡œìš´ ì£¼ì°¨ ì´ˆê¸°í™” ì‘ì—…
  weekly-reset:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 0 * * 1' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'reset')
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
          
      - name: Install dependencies
        run: |
          pip install requests pytz
          
      - name: Check if new week started
        id: check_week
        run: |
          python -c "
          from datetime import datetime
          import sys
          import os
          sys.path.append('.')
          
          try:
              from session_counter import get_session_info
              current_session = get_session_info()
              today = datetime.now().strftime('%Y-%m-%d')
              
              # ì˜¤ëŠ˜ì´ ìƒˆë¡œìš´ ì£¼ì°¨ì˜ ì›”ìš”ì¼ì¸ì§€ í™•ì¸
              if today == current_session['monday']:
                  print('NEW_WEEK=true')
                  print(f'SESSION_NUMBER={current_session[\"session_number\"]}')
              else:
                  print('NEW_WEEK=false')
          except Exception as e:
              print(f'Error: {e}')
              print('NEW_WEEK=false')
          " >> $GITHUB_ENV
          
      - name: Reset README for new week
        if: env.NEW_WEEK == 'true'
        run: |
          echo "ğŸ”„ ìƒˆë¡œìš´ ì£¼ì°¨ ì‹œì‘ - README.md ì´ˆê¸°í™” ì¤‘..."
          python scripts/weekly_reset.py
          
      - name: Commit and push changes
        if: env.NEW_WEEK == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "ğŸ”„ ìƒˆë¡œìš´ ${SESSION_NUMBER}íšŒì°¨ ì‹œì‘ - README.md ì´ˆê¸°í™”"
          git push
          
      - name: Notify new week start
        if: env.NEW_WEEK == 'true'
        env:
          YEOMIN4242_MATTERMOST_URL: ${{ secrets.YEOMIN4242_MATTERMOST_URL }}
        run: |
          python -c "
          import requests
          import os
          import sys
          sys.path.append('.')
          
          try:
              from session_counter import get_session_info
              session_info = get_session_info()
              
              message = f'''ğŸš€ **ìƒˆë¡œìš´ {session_info['session_number']}íšŒì°¨ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!**
              
              ğŸ“… **ê¸°ê°„**: {session_info['monday']} ~ {session_info['sunday']}
              â° **ë§ˆê°**: {session_info['deadline']}
              
              ğŸ’ª ì´ë²ˆ ì£¼ë„ í™”ì´íŒ…í•˜ì„¸ìš”!
              '''
              
              webhook_url = os.environ.get('YEOMIN4242_MATTERMOST_URL')
              if webhook_url:
                  response = requests.post(webhook_url, json={'text': message})
                  if response.status_code == 200:
                      print('âœ… ìƒˆ ì£¼ì°¨ ì‹œì‘ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ')
                  else:
                      print(f'âŒ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: {response.status_code}')
              else:
                  print('âš ï¸ Mattermost webhook URLì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ')
                  
          except Exception as e:
              print(f'âŒ ì•Œë¦¼ ì „ì†¡ ì¤‘ ì˜¤ë¥˜: {e}')
          "
          
      - name: Skip if not new week
        if: env.NEW_WEEK != 'true'
        run: |
          echo "â„¹ï¸ ìƒˆë¡œìš´ ì£¼ì°¨ê°€ ì•„ë‹ˆë¯€ë¡œ README ì´ˆê¸°í™”ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."